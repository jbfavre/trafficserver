Description: Fix kfreebsd build skipping malloc_np.h include
Author: Jean Baptiste Favre <debiabn@jbfavre.org>
Origin: other
Last-Update: 2017-03-24
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/lib/ts/ink_memory.cc
+++ b/lib/ts/ink_memory.cc
@@ -27,7 +27,7 @@
 #include "ts/Diags.h"
 #include "ts/ink_atomic.h"
 
-#if defined(freebsd)
+#if !defined(kfreebsd) && defined(freebsd)
 #include <malloc_np.h> // for malloc_usable_size
 #endif
 
--- a/proxy/Plugin.cc
+++ b/proxy/Plugin.cc
@@ -124,7 +124,7 @@ plugin_load(int argc, char *argv[], bool validateOnly)
       return false; // this line won't get called since Fatal brings down ATS
     }
 
-#if defined(freebsd) || defined(darwin)
+#if (!defined(kfreebsd) && defined(freebsd)) || defined(darwin)
     optreset = 1;
 #endif
 #if defined(__GLIBC__)
--- a/proxy/http/remap/RemapConfig.cc
+++ b/proxy/http/remap/RemapConfig.cc
@@ -902,7 +902,7 @@ remap_load_plugin(const char **argv, int argc, url_mapping *mp, char *errbuf, in
   void *ih         = NULL;
   TSReturnCode res = TS_SUCCESS;
   if (pi->fp_tsremap_new_instance) {
-#if defined(freebsd) || defined(darwin)
+#if (!defined(kfreebsd) && defined(freebsd)) || defined(darwin)
     optreset = 1;
 #endif
 #if defined(__GLIBC__)
